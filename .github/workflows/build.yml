name: Build Custom Caddy

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'go.mod' # ä»…ç›‘å¬ä¾èµ–å˜åŒ–

permissions:
  contents: write

env:
  TZ: Asia/Shanghai # å…¨å±€æ—¶åŒº

jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.ver.outputs.tag }}
      build_time: ${{ steps.ver.outputs.time }}
    steps:
      - name: Generate Global Version Tag
        id: ver
        run: |
          # å¼ºåˆ¶åŒ—äº¬æ—¶é—´ç”Ÿæˆ
          export TZ='Asia/Shanghai'
          echo "tag=v$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
          echo "time=$(date +'%Y-%m-%d %H:%M:%S (Beijing)')" >> $GITHUB_OUTPUT

  build:
    needs: init
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goarch: amd64
            goos: linux
            output_name: caddy-linux-amd64
          - goarch: arm64
            goos: linux
            output_name: caddy-linux-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          check-latest: true

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      - name: Analyze Dependencies
        id: analyze
        run: python3 scripts/gen_info.py

      - name: Build Caddy (${{ matrix.goarch }})
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          export GOFLAGS="-ldflags=-X=github.com/caddyserver/caddy/v2.CustomVersion=${{ needs.init.outputs.version_tag }}"
          
          ~/go/bin/xcaddy build \
            --output ${{ matrix.output_name }} \
            ${{ steps.analyze.outputs.XCADDY_ARGS }}

      - name: Generate Comprehensive Release Notes
        if: matrix.goarch == 'amd64'
        run: |
          chmod +x ${{ matrix.output_name }}
          
          # 1. è·å–æ•°æ®æº
          go list -m -json all > go_modules.json

          # 2. å‡†å¤‡å˜é‡
          CUSTOM_VERSION="${{ needs.init.outputs.version_tag }}"
          BUILD_TIME="${{ needs.init.outputs.build_time }}"
          GO_VERSION=$(go version | awk '{print $3}')

          # 3. æå– Caddy Core ä¿¡æ¯
          CADDY_CORE_INFO=$(jq -r '
            select(.Path == "github.com/caddyserver/caddy/v2") | 
            if .Replace != null then 
              "\(.Replace.Version) (\(.Replace.Sum))"
            else 
              "\(.Version) (\(.Sum))"
            end
          ' go_modules.json)

          # 4. ç”Ÿæˆå¤´éƒ¨ (Build Info)
          cat <<EOF > final_note.md
          # $CUSTOM_VERSION

          ### ğŸš€ Build Info
          - **Custom Version**: $CUSTOM_VERSION
          - **Caddy Core**: \`$CADDY_CORE_INFO\`
          - **Go Version**: \`$GO_VERSION\`
          - **Build Time**: $BUILD_TIME

          EOF

          # ========================================================
          # 5. å¤„ç†å˜åŠ¨æ—¥å¿— (Caddyç½®é¡¶ + å‰©ä½™é¦–å­—æ¯æ’åº)
          # ========================================================
          echo "### ğŸ“¦ Plugin Changes" >> final_note.md
          echo "" >> final_note.md

          # æ£€æŸ¥ release_notes.md æ˜¯å¦å­˜åœ¨ä¸”éç©º
          if [ -s release_notes.md ]; then
            # ä¸´æ—¶æ–‡ä»¶
            touch _caddy_changes.txt _other_changes.txt

            # é€è¡Œè¯»å–ï¼ŒåŒºåˆ† Caddy å’Œ å…¶ä»–æ’ä»¶
            while IFS= read -r line; do
              # å¿½ç•¥ç©ºè¡Œ
              if [[ -z "$line" ]]; then continue; fi
              
              # åˆ¤æ–­æ˜¯å¦åŒ…å« Caddy (ä¸åŒºåˆ†å¤§å°å†™)
              if echo "$line" | grep -qi "caddy"; then
                echo "$line" >> _caddy_changes.txt
              else
                echo "$line" >> _other_changes.txt
              fi
            done < release_notes.md

            # 1. å…ˆå†™å…¥ Caddy å˜åŠ¨
            if [ -s _caddy_changes.txt ]; then
              cat _caddy_changes.txt >> final_note.md
            fi

            # 2. å†å†™å…¥å…¶ä»–å˜åŠ¨ (sort è¿›è¡Œé¦–å­—æ¯æ’åº)
            if [ -s _other_changes.txt ]; then
              sort _other_changes.txt >> final_note.md
            fi
            
            # å¦‚æœä¸¤ä¸ªéƒ½ä¸ºç©º(ä¾‹å¦‚å…¨æ˜¯ç©ºè¡Œ)ï¼Œè¡¥ä¸€å¥æ— å˜åŠ¨
            if [ ! -s _caddy_changes.txt ] && [ ! -s _other_changes.txt ]; then
               echo "No plugin updates detected in this build." >> final_note.md
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f _caddy_changes.txt _other_changes.txt
          else
            echo "No plugin updates detected in this build." >> final_note.md
          fi
          echo "" >> final_note.md

          # ========================================================
          # 6. ç”Ÿæˆæ’ä»¶åˆ—è¡¨ (æŒ‰ç…§ plugins.txt é¡ºåº)
          # ========================================================
          cat <<EOF >> final_note.md
          ### ğŸ”Œ Installed Plugins Status
          | Plugin | Version | Time (Beijing) |
          | :--- | :--- | :--- |
          EOF

          grep -vE '^\s*#|^\s*$' plugins.txt | while read -r line; do
            if [[ "$line" == *"="* ]]; then
              SEARCH_KEY=$(echo "$line" | cut -d'=' -f1 | xargs)
            else
              SEARCH_KEY=$(echo "$line" | xargs)
            fi

            # è¿‡æ»¤ Caddy Core
            if [[ "$SEARCH_KEY" == "github.com/caddyserver/caddy/v2" ]]; then
              continue
            fi

            INFO_JSON=$(jq -r --arg name "$SEARCH_KEY" '
              select(.Path == $name) | 
              if .Replace != null then 
                {path: .Replace.Path, ver: .Replace.Version, time: .Replace.Time} 
              else 
                {path: .Path, ver: .Version, time: .Time} 
              end
            ' go_modules.json)

            if [[ -z "$INFO_JSON" || "$INFO_JSON" == "null" ]]; then
              continue
            fi

            REAL_PATH=$(echo "$INFO_JSON" | jq -r .path)
            RAW_VER=$(echo "$INFO_JSON" | jq -r .ver)
            RAW_TIME=$(echo "$INFO_JSON" | jq -r .time)

            # æ˜¾ç¤ºåç§°: å»æ‰åŸŸåï¼Œä¿ç•™ ç”¨æˆ·/ä»“åº“ (å¦‚ klzgrad/forwardproxy)
            DISPLAY_NAME=$(echo "$REAL_PATH" | cut -d'/' -f2-)
            LINK="https://$REAL_PATH"

            # ç‰ˆæœ¬é€»è¾‘
            DISPLAY_VER="$RAW_VER"
            if [[ "$RAW_VER" =~ .*-.*-.* ]]; then
                COMMIT_HASH=$(echo "$RAW_VER" | awk -F- '{print $NF}' | cut -c1-7)
                DISPLAY_VER="Commit: $COMMIT_HASH"
            fi

            # æ—¶é—´é€»è¾‘
            if [[ -n "$RAW_TIME" && "$RAW_TIME" != "null" ]]; then
                DISPLAY_TIME=$(date -d "$RAW_TIME +8 hours" '+%Y-%m-%d %H:%M:%S')
            else
                DISPLAY_TIME="N/A"
            fi

            echo "| [$DISPLAY_NAME]($LINK) | $DISPLAY_VER | $DISPLAY_TIME |" >> final_note.md
          done

      - name: Generate Checksum
        run: sha256sum ${{ matrix.output_name }} > ${{ matrix.output_name }}.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: caddy-${{ matrix.goarch }}
          path: |
            ${{ matrix.output_name }}
            ${{ matrix.output_name }}.sha256
            final_note.md
            manifest.json

  release:
    needs: [init, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Body
        run: |
          cat artifacts/caddy-amd64/final_note.md > body.md
          echo "" >> body.md
          echo "### ğŸ›¡ï¸ SHA256 Checksums" >> body.md
          echo "\`\`\`" >> body.md
          cat artifacts/caddy-amd64/*.sha256 >> body.md
          cat artifacts/caddy-arm64/*.sha256 >> body.md
          echo "\`\`\`" >> body.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.init.outputs.version_tag }}
          name: ${{ needs.init.outputs.version_tag }}
          body_path: body.md
          files: |
            artifacts/caddy-amd64/caddy-linux-amd64
            artifacts/caddy-amd64/caddy-linux-amd64.sha256
            artifacts/caddy-arm64/caddy-linux-arm64
            artifacts/caddy-arm64/caddy-linux-arm64.sha256
            artifacts/caddy-amd64/manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
