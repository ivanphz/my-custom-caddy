name: Build Custom Caddy

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'go.mod' # ä»…ç›‘å¬ä¾èµ–å˜åŒ–

permissions:
  contents: write

env:
  TZ: Asia/Shanghai # å…¨å±€æ—¶åŒº

jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.ver.outputs.tag }}
      build_time: ${{ steps.ver.outputs.time }}
    steps:
      - name: Generate Global Version Tag
        id: ver
        run: |
          # å¼ºåˆ¶åŒ—äº¬æ—¶é—´ç”Ÿæˆ
          export TZ='Asia/Shanghai'
          echo "tag=v$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
          echo "time=$(date +'%Y-%m-%d %H:%M:%S (Beijing)')" >> $GITHUB_OUTPUT

  build:
    needs: init
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goarch: amd64
            goos: linux
            output_name: caddy-linux-amd64
          - goarch: arm64
            goos: linux
            output_name: caddy-linux-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          check-latest: true

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      - name: Analyze Dependencies
        id: analyze
        run: python3 scripts/gen_info.py

      - name: Build Caddy (${{ matrix.goarch }})
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          export GOFLAGS="-ldflags=-X=github.com/caddyserver/caddy/v2.CustomVersion=${{ needs.init.outputs.version_tag }}"
          
          ~/go/bin/xcaddy build \
            --output ${{ matrix.output_name }} \
            ${{ steps.analyze.outputs.XCADDY_ARGS }}

      - name: Generate Comprehensive Release Notes
        if: matrix.goarch == 'amd64'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ${{ matrix.output_name }}
          
          # 1. ç”Ÿæˆå½“å‰çš„æ¨¡å—æ¸…å•
          go list -m -json all > go_modules.json

          # 2. å°è¯•ä¸‹è½½ä¸Šä¸€ä¸ª Release çš„æ¨¡å—æ¸…å• (ç”¨äºå¯¹æ¯”)
          echo "Downloading previous build info..."
          # å®¹é”™ï¼šå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œæˆ–ä¸‹è½½å¤±è´¥ï¼Œç”Ÿæˆä¸€ä¸ªç©ºæ•°ç»„ï¼Œè§†ä¸ºå…¨éƒ¨æ˜¯æ–°å¢
          gh release download --pattern "go_modules.json" --output prev_go_modules.json || echo "[]" > prev_go_modules.json

          # 3. å‡†å¤‡ Python è„šæœ¬è¿›è¡Œæ™ºèƒ½å¯¹æ¯” (Shell å¤„ç†å¤æ‚ JSON å¯¹æ¯”å¤ªéš¾äº†ï¼Œç”¨ Python)
          cat <<'EOF' > diff_logic.py
          import json
          import os
          import re
          from datetime import datetime, timedelta

          # å·¥å…·ï¼šæ ¼å¼åŒ–ç‰ˆæœ¬å· (å¤„ç†ä¼ªç‰ˆæœ¬)
          def fmt_ver(v):
              if '-' in v and len(v.split('-')[-1]) >= 12: # æ£€æµ‹ä¼ªç‰ˆæœ¬
                  return f"Commit: {v.split('-')[-1][:7]}"
              return v

          # å·¥å…·ï¼šç®€åŒ–åç§° (å»æ‰åŸŸå)
          def fmt_name(path):
              return "/".join(path.split("/")[-2:]) if "/" in path else path

          # 1. åŠ è½½æ•°æ®
          def load_json(fn):
              try:
                  with open(fn, 'r') as f:
                      data = json.load(f)
                      # è½¬æ¢ä¸ºå­—å…¸: Path -> Info
                      # ä¼˜å…ˆä½¿ç”¨ Replace åçš„ä¿¡æ¯
                      res = {}
                      if isinstance(data, dict): data = [data] # å¤„ç†å•æ¡è®°å½•çš„æƒ…å†µ
                      for item in data:
                          path = item.get('Path')
                          if item.get('Replace'):
                              res[path] = item['Replace']
                              res[path]['OriginalPath'] = path # è®°å½•åŸå§‹è·¯å¾„ä»¥ä¾¿åŒ¹é…
                          else:
                              res[path] = item
                      return res
              except:
                  return {}

          curr = load_json('go_modules.json')
          prev = load_json('prev_go_modules.json')

          # 2. è¯»å– plugins.txt ç¡®å®šæˆ‘ä»¬å…³æ³¨çš„æ’ä»¶åˆ—è¡¨
          # (é¿å…æŠŠåº•å±‚çš„ Go ä¾èµ–å˜åŠ¨ä¹ŸæŠ¥å‡ºæ¥ï¼Œå¤ªåµ)
          tracked_plugins = set()
          if os.path.exists('plugins.txt'):
              with open('plugins.txt', 'r') as f:
                  for line in f:
                      line = line.strip()
                      if not line or line.startswith('#'): continue
                      # å¤„ç† name=replace
                      if '=' in line: line = line.split('=')[0].strip()
                      tracked_plugins.add(line)

          changes_caddy = []
          changes_other = []

          # 3. æ ¸å¿ƒå¯¹æ¯”é€»è¾‘
          all_paths = set(curr.keys()) | set(prev.keys())
          
          for path in all_paths:
              # è¿‡æ»¤ï¼šåªå…³æ³¨ plugins.txt é‡Œçš„ï¼Œæˆ–è€… Caddy æ ¸å¿ƒï¼Œæˆ–è€…æ˜¯ä¹‹å‰å­˜åœ¨è¿‡çš„æ’ä»¶
              is_caddy_core = (path == "github.com/caddyserver/caddy/v2")
              
              # å¦‚æœæ—¢ä¸æ˜¯Caddyï¼Œä¹Ÿä¸åœ¨plugins.txté‡Œï¼Œä¸”ä¸çœ‹èµ·æ¥åƒä¸ªæ’ä»¶(ç®€å•çš„è¿‡æ»¤)ï¼Œè·³è¿‡
              # è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šå¦‚æœå®ƒå‡ºç°åœ¨ plugins.txt é‡Œï¼Œæˆ–è€…å®ƒæ˜¯è¢«åˆ é™¤çš„æ’ä»¶ï¼Œæˆ‘ä»¬éƒ½è¦è®°å½•
              relevant = (path in tracked_plugins) or is_caddy_core
              
              # é’ˆå¯¹â€œRemovedâ€çš„æƒ…å†µï¼Œpath ä¸åœ¨ curr é‡Œï¼Œæ²¡æ³•æŸ¥ plugins.txt (å‡å¦‚ç”¨æˆ·åˆ äº†è¡Œ)
              # æ‰€ä»¥æˆ‘ä»¬æ”¾å®½ä¸€ç‚¹ï¼šå¦‚æœæ˜¯ Removedï¼Œä¸”çœ‹èµ·æ¥åƒ github ä»“åº“ï¼Œå°±åˆ—å‡ºæ¥
              if path not in curr and "github.com" in path:
                  relevant = True

              if not relevant: continue

              name = fmt_name(path)
              link = f"https://{path}"

              # A. æ–°å¢ (Added)
              if path not in prev:
                  ver = fmt_ver(curr[path]['Version'])
                  msg = f"âœ¨ **Added**: [{name}]({link}) `{ver}`"
                  if is_caddy_core: changes_caddy.append(msg)
                  else: changes_other.append(msg)

              # B. åˆ é™¤ (Removed)
              elif path not in curr:
                  msg = f"ğŸ—‘ï¸ **Removed**: [{name}]({link})"
                  if is_caddy_core: changes_caddy.append(msg)
                  else: changes_other.append(msg)

              # C. æ›´æ–° (Updated)
              elif prev[path]['Version'] != curr[path]['Version']:
                  v_old = fmt_ver(prev[path]['Version'])
                  v_new = fmt_ver(curr[path]['Version'])
                  msg = f"â¬†ï¸ **Updated**: [{name}]({link}) `{v_old}` -> `{v_new}`"
                  if is_caddy_core: changes_caddy.append(msg)
                  else: changes_other.append(msg)

          # 4. è¾“å‡ºå˜åŠ¨æ—¥å¿—
          if not changes_caddy and not changes_other:
              print("No plugin updates detected in this build.")
          else:
              for c in changes_caddy: print(c)
              for c in sorted(changes_other): print(c) # é¦–å­—æ¯æ’åº
          EOF

          # 4. æ‰§è¡Œ Python è„šæœ¬ç”Ÿæˆå˜åŠ¨å†…å®¹
          python3 diff_logic.py > change_log.md

          # 5. å‡†å¤‡åŸºç¡€å˜é‡
          CUSTOM_VERSION="${{ needs.init.outputs.version_tag }}"
          BUILD_TIME="${{ needs.init.outputs.build_time }}"
          GO_VERSION=$(go version | awk '{print $3}')
          
          # è·å– Caddy Core ä¿¡æ¯ (ç”¨äº Build Info)
          CADDY_CORE_INFO=$(jq -r 'select(.Path == "github.com/caddyserver/caddy/v2") | "\(.Version) (\(.Sum))"' go_modules.json)

          # 6. ç»„è£… final_note.md
          cat <<EOF > final_note.md
          # $CUSTOM_VERSION

          ### ğŸš€ Build Info
          - **Custom Version**: $CUSTOM_VERSION
          - **Caddy Core**: \`$CADDY_CORE_INFO\`
          - **Go Version**: \`$GO_VERSION\`
          - **Build Time**: $BUILD_TIME

          ### ğŸ“¦ Plugin Changes
          EOF
          
          # æ’å…¥å˜åŠ¨æ—¥å¿—
          cat change_log.md >> final_note.md
          
          cat <<EOF >> final_note.md

          ### ğŸ”Œ Installed Plugins Status
          | Plugin | Version | Time (Beijing) |
          | :--- | :--- | :--- |
          EOF

          # 7. ç”Ÿæˆæ’ä»¶åˆ—è¡¨è¡¨æ ¼ (é€»è¾‘ä¿æŒä¸å˜)
          grep -vE '^\s*#|^\s*$' plugins.txt | while read -r line; do
            if [[ "$line" == *"="* ]]; then SEARCH_KEY=$(echo "$line" | cut -d'=' -f1 | xargs); else SEARCH_KEY=$(echo "$line" | xargs); fi
            if [[ "$SEARCH_KEY" == "github.com/caddyserver/caddy/v2" ]]; then continue; fi

            INFO_JSON=$(jq -r --arg name "$SEARCH_KEY" 'select(.Path == $name) | if .Replace != null then {path: .Replace.Path, ver: .Replace.Version, time: .Replace.Time} else {path: .Path, ver: .Version, time: .Time} end' go_modules.json)
            if [[ -z "$INFO_JSON" || "$INFO_JSON" == "null" ]]; then continue; fi

            REAL_PATH=$(echo "$INFO_JSON" | jq -r .path)
            RAW_VER=$(echo "$INFO_JSON" | jq -r .ver)
            RAW_TIME=$(echo "$INFO_JSON" | jq -r .time)
            
            DISPLAY_NAME=$(echo "$REAL_PATH" | cut -d'/' -f2-)
            LINK="https://$REAL_PATH"
            
            DISPLAY_VER="$RAW_VER"
            if [[ "$RAW_VER" =~ .*-.*-.* ]]; then
                COMMIT_HASH=$(echo "$RAW_VER" | awk -F- '{print $NF}' | cut -c1-7)
                DISPLAY_VER="Commit: $COMMIT_HASH"
            fi
            
            if [[ -n "$RAW_TIME" && "$RAW_TIME" != "null" ]]; then
                DISPLAY_TIME=$(date -d "$RAW_TIME +8 hours" '+%Y-%m-%d %H:%M:%S')
            else
                DISPLAY_TIME="N/A"
            fi
            echo "| [$DISPLAY_NAME]($LINK) | $DISPLAY_VER | $DISPLAY_TIME |" >> final_note.md
          done

      - name: Generate Checksum
        run: sha256sum ${{ matrix.output_name }} > ${{ matrix.output_name }}.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: caddy-${{ matrix.goarch }}
          path: |
            ${{ matrix.output_name }}
            ${{ matrix.output_name }}.sha256
            final_note.md
            manifest.json
            go_modules.json

  release:
    needs: [init, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Body
        run: |
          cat artifacts/caddy-amd64/final_note.md > body.md
          echo "" >> body.md
          echo "### ğŸ›¡ï¸ SHA256 Checksums" >> body.md
          echo "\`\`\`" >> body.md
          cat artifacts/caddy-amd64/*.sha256 >> body.md
          cat artifacts/caddy-arm64/*.sha256 >> body.md
          echo "\`\`\`" >> body.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.init.outputs.version_tag }}
          name: ${{ needs.init.outputs.version_tag }}
          body_path: body.md
          files: |
            artifacts/caddy-amd64/caddy-linux-amd64
            artifacts/caddy-amd64/caddy-linux-amd64.sha256
            artifacts/caddy-arm64/caddy-linux-arm64
            artifacts/caddy-arm64/caddy-linux-arm64.sha256
            artifacts/caddy-amd64/manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
