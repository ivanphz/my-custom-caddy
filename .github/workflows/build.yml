name: Build Custom Caddy

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'go.mod'

permissions:
  contents: write

env:
  TZ: Asia/Shanghai

jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.ver.outputs.tag }}
      build_time: ${{ steps.ver.outputs.time }}
    steps:
      - name: Generate Global Version Tag
        id: ver
        run: |
          export TZ='Asia/Shanghai'
          echo "tag=v$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
          echo "time=$(date +'%Y-%m-%d %H:%M:%S (Beijing)')" >> $GITHUB_OUTPUT

  build:
    needs: init
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goarch: amd64
            goos: linux
            output_name: caddy-linux-amd64
          - goarch: arm64
            goos: linux
            output_name: caddy-linux-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          check-latest: true

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      # ============================================================
      # 1. ÁÆÄÂçïÁ≤óÊö¥Âú∞ËØªÂèñ plugins.txt ÁîüÊàêÁºñËØëÂèÇÊï∞
      # ============================================================
      - name: Prepare XCaddy Args
        id: args
        run: |
          ARGS=$(awk '
            /^[[:space:]]*$/ || /^[[:space:]]*#/ { next }
            /github.com\/caddyserver\/caddy\/v2/ { next }
            { printf "--with %s ", $1 }
          ' plugins.txt)

          # Â∑≤ÁßªÈô§"Êó†Êèí‰ª∂Êä•ÈîôÈÄÄÂá∫"ÁöÑÈÄªËæë
          echo "XCADDY_ARGS=$ARGS" >> $GITHUB_OUTPUT

      # ============================================================
      # 2. ‰øÆÊ≠£ÂêéÁöÑÊûÑÂª∫ÊµÅÁ®ãÔºàÂ§çÁî®Ê†πÁõÆÂΩï go.modÔºâ
      # ============================================================
      - name: Build Caddy (${{ matrix.goarch }})
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          # 1. ÁîüÊàê main.go Âà∞Ê†πÁõÆÂΩï (Áõ¥Êé•Ë¶ÜÁõñÊàñÊñ∞Âª∫)
          cat > main.go << 'MAINEOF'
          package main
          
          import (
              caddycmd "github.com/caddyserver/caddy/v2/cmd"
              _ "github.com/caddyserver/caddy/v2/modules/standard"
          MAINEOF
          
          # ‰ªé plugins.txt ËØªÂèñÂπ∂Ê∑ªÂä† import
          grep -vE '^\s*#|^\s*$' plugins.txt | while read -r line; do
            if [[ "$line" == *"="* ]]; then
              PKG=$(echo "$line" | cut -d'=' -f1 | xargs)
            else
              PKG=$(echo "$line" | xargs)
            fi
            if [[ "$PKG" != "github.com/caddyserver/caddy/v2" ]]; then
              echo "    _ \"$PKG\"" >> main.go
            fi
          done
          
          cat >> main.go << 'MAINEOF'
          )
          
          func main() {
              caddycmd.Main()
          }
          MAINEOF
          
          # 2. ÂÖ≥ÈîÆÔºöÁ°Æ‰øù‰æùËµñÂêåÊ≠•
          # ËøôÈáåÁöÑ go mod tidy ‰ºöÂà©Áî®Áé∞ÊúâÁöÑ go.mod/go.sumÔºåÁ°Æ‰øùÁâàÊú¨‰∏ÄËá¥
          # Â¶ÇÊûú main.go ÂºïÂÖ•‰∫Ü tools.go Ê≤°ÂåÖÂê´ÁöÑ‰∏úË•øÔºåÂÆÉ‰ºö‰∏ãËΩΩÔºå‰ΩÜÂ§ßÈÉ®ÂàÜÂ∫îËØ•Â∑≤ÈîÅÂÆö
          go mod tidy
          
          # 3. ÁºñËØë
          go build -o "${{ matrix.output_name }}" \
            -ldflags="-w -s -X github.com/caddyserver/caddy/v2.CustomVersion=${{ needs.init.outputs.version_tag }}" \
            -trimpath \
            -tags nobadger,nomysql,nopgx

      # ============================================================
      # 2.5 ÊµãËØïÁâàÊú¨ËæìÂá∫ÔºàÊñ∞Â¢ûÔºåÁî®‰∫éË∞ÉËØïÔºâ
      # ============================================================
      - name: Test Version Output
        run: |
          chmod +x ./${{ matrix.output_name }}
          echo "=== caddy version ==="
          ./${{ matrix.output_name }} version || true
          echo ""
          echo "=== caddy --version ==="
          ./${{ matrix.output_name }} --version || true
          echo ""
          echo "=== caddy list-modules (first 5) ==="
          ./${{ matrix.output_name }} list-modules --versions | head -n 5 || true

      # ============================================================
      # 3. ÁîüÊàêÊó•Âøó (‰øÆÂ§ç‰∫Ü JSON Ê†ºÂºèÈóÆÈ¢ò)
      # ============================================================
      - name: Generate Comprehensive Release Notes
        if: matrix.goarch == 'amd64'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ${{ matrix.output_name }}
          
          # 1. ÁîüÊàêÂΩìÂâç JSON
          go list -m -json all | jq -s '.' > go_modules.json

          # 2. ‰∏ãËΩΩÂØπÊØîÊñá‰ª∂
          echo "Downloading previous build info..."
          gh release download --pattern "go_modules.json" --output prev_go_modules.json || echo "[]" > prev_go_modules.json

          # 3. Python ÂØπÊØîËÑöÊú¨ (Â∑≤‰øÆÂ§ç KeyError Â¥©Ê∫ÉÈóÆÈ¢ò)
          cat <<'EOF' > diff_logic.py
          import json
          import os
          import sys

          def fmt_ver(v):
              if not v: return "N/A"
              if '-' in v and len(v.split('-')[-1]) >= 12: return f"Commit: {v.split('-')[-1][:7]}"
              return v

          def fmt_name(path):
              return "/".join(path.split("/")[-2:]) if "/" in path else path

          def load_json(fn):
              try:
                  with open(fn, 'r') as f:
                      data = json.load(f)
                      res = {}
                      for item in data:
                          # „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç1„ÄëÂøΩÁï•‰∏ªÊ®°Âùó (ÂÆÉÊ≤°Êúâ Version Â≠óÊÆµÔºå‰ºöÂØºËá¥Â¥©Ê∫É)
                          if item.get('Main'): continue
                          
                          path = item.get('Path')
                          if not path: continue
                          
                          # Â¶ÇÊûúÊúâ ReplaceÔºå‰ºòÂÖàËØªÂèñ Replace ÁöÑ‰ø°ÊÅØ
                          # ‰ΩÜ‰øùÁïôÂéüÂßã Item ÁöÑ Indirect Áä∂ÊÄÅÁî®‰∫éÂà§Êñ≠
                          if item.get('Replace'):
                              orig_indirect = item.get('Indirect', False)
                              res[path] = item['Replace']
                              res[path]['Indirect'] = orig_indirect
                          else:
                              res[path] = item
                      return res
              except Exception as e:
                  return {}

          curr = load_json('go_modules.json')
          prev = load_json('prev_go_modules.json')

          if not curr:
              print("‚ö†Ô∏è Error: Failed to parse current module list.")
              sys.exit(0)

          # ËØªÂèñÂΩìÂâç plugins.txt
          tracked = set()
          if os.path.exists('plugins.txt'):
              with open('plugins.txt', 'r') as f:
                  for line in f:
                      line = line.strip()
                      if not line or line.startswith('#'): continue
                      if '=' in line: line = line.split('=')[0].strip()
                      tracked.add(line)

          changes_other = []
          all_paths = set(curr.keys()) | set(prev.keys())
          
          for path in all_paths:
              # 1. ÂΩªÂ∫ïÂøΩÁï• Caddy Core
              if path == "github.com/caddyserver/caddy/v2": continue

              is_removed = (path in prev and path not in curr)
              
              # 2. Ê†∏ÂøÉÂà§ÂÆöÈÄªËæë (‰ΩøÁî® Indirect Â±ûÊÄß)
              is_relevant = False

              if path in curr:
                  # Â¶ÇÊûúÂú® plugins.txt ÈáåÔºåÊàñËÄÖ Indirect=False (Áõ¥Êé•‰æùËµñ)ÔºåÂàôÊòæÁ§∫
                  if path in tracked:
                      is_relevant = True
                  elif curr[path].get('Indirect', False) is False: 
                      is_relevant = True

              elif is_removed:
                  # Â¶ÇÊûúÊóßÁâàÈáå Indirect=FalseÔºåËØ¥ÊòéÂÆÉÊòØÊóßÁâàÁöÑ‰∏Ä‰∏™Êèí‰ª∂ÔºåÁé∞Âú®Ë¢´Âà†‰∫Ü -> ËÆ∞ÂΩï
                  if prev[path].get('Indirect', False) is False:
                      is_relevant = True

              if not is_relevant: continue

              # 3. ÁªÑË£ÖÊòæÁ§∫‰ø°ÊÅØ
              display_path = path
              if path in curr:
                  display_path = curr[path].get('Path', path)
              elif path in prev:
                  display_path = prev[path].get('Path', path)

              name = fmt_name(display_path)
              link = f"https://{display_path}"

              # „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç2„Äë‰ΩøÁî® .get() ÂÆâÂÖ®Ëé∑ÂèñÁâàÊú¨ÔºåÈò≤Ê≠¢‰ªª‰ΩïÊΩúÂú®ÁöÑ KeyError
              v_curr = curr.get(path, {}).get('Version', '')
              v_prev = prev.get(path, {}).get('Version', '')

              if is_removed:
                  msg = f"üóëÔ∏è **Removed**: [{name}]({link})"
                  changes_other.append(msg)
              elif path not in prev:
                  msg = f"‚ú® **Added**: [{name}]({link}) `{fmt_ver(v_curr)}`"
                  changes_other.append(msg)
              elif v_prev != v_curr:
                  msg = f"‚¨ÜÔ∏è **Updated**: [{name}]({link}) `{fmt_ver(v_prev)}` -> `{fmt_ver(v_curr)}`"
                  changes_other.append(msg)

          if not changes_other:
              print("No plugin updates detected in this build.")
          else:
              for c in sorted(changes_other): print(c)
          EOF

          python3 diff_logic.py > change_log.md

          # 4. ÁªÑË£Ö Final Note
          CUSTOM_VERSION="${{ needs.init.outputs.version_tag }}"
          BUILD_TIME="${{ needs.init.outputs.build_time }}"
          GO_VERSION=$(go version | awk '{print $3}')
          CADDY_INFO=$(jq -r '.[] | select(.Path == "github.com/caddyserver/caddy/v2") | "\(.Version) (\(.Sum))"' go_modules.json)

          cat <<EOF > final_note.md
          # $CUSTOM_VERSION

          ### üöÄ Build Info
          - **Custom Version**: $CUSTOM_VERSION
          - **Caddy Core**: \`$CADDY_INFO\`
          - **Go Version**: \`$GO_VERSION\`
          - **Build Time**: $BUILD_TIME

          ### üì¶ Plugin Changes
          EOF
          cat change_log.md >> final_note.md

          cat <<EOF >> final_note.md

          ### üîå Installed Plugins Status
          | Plugin | Version | Time (Beijing) |
          | :--- | :--- | :--- |
          EOF

          # 5. ÁîüÊàêË°®Ê†º
          grep -vE '^\s*#|^\s*$' plugins.txt | while read -r line; do
            if [[ "$line" == *"="* ]]; then SEARCH=$(echo "$line" | cut -d'=' -f1 | xargs); else SEARCH=$(echo "$line" | xargs); fi
            if [[ "$SEARCH" == "github.com/caddyserver/caddy/v2" ]]; then continue; fi

            INFO=$(jq -r --arg n "$SEARCH" '.[] | select(.Path == $n) | if .Replace!=null then {p:.Replace.Path, v:.Replace.Version, t:.Replace.Time} else {p:.Path, v:.Version, t:.Time} end' go_modules.json)
            if [[ -z "$INFO" || "$INFO" == "null" ]]; then continue; fi
            
            PATH_R=$(echo "$INFO" | jq -r .p)
            VER_R=$(echo "$INFO" | jq -r .v)
            TIME_R=$(echo "$INFO" | jq -r .t)
            
            NAME_DISP=$(echo "$PATH_R" | cut -d'/' -f2-)
            VER_DISP="$VER_R"
            if [[ "$VER_R" =~ .*-.*-.* ]]; then VER_DISP="Commit: $(echo $VER_R | awk -F- '{print $NF}' | cut -c1-7)"; fi
            
            TIME_DISP="N/A"
            if [[ -n "$TIME_R" && "$TIME_R" != "null" ]]; then TIME_DISP=$(date -d "$TIME_R +8 hours" '+%Y-%m-%d %H:%M:%S'); fi
            
            echo "| [$NAME_DISP](https://$PATH_R) | $VER_DISP | $TIME_DISP |" >> final_note.md
          done
          
      - name: Generate Checksum
        run: sha256sum ${{ matrix.output_name }} > ${{ matrix.output_name }}.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: caddy-${{ matrix.goarch }}
          path: |
            ${{ matrix.output_name }}
            ${{ matrix.output_name }}.sha256
            final_note.md
            go_modules.json

  release:
    needs: [init, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Body
        run: |
          cat artifacts/caddy-amd64/final_note.md > body.md
          echo "" >> body.md
          echo "### üõ°Ô∏è SHA256 Checksums" >> body.md
          echo "\`\`\`" >> body.md
          cat artifacts/caddy-amd64/*.sha256 >> body.md
          cat artifacts/caddy-arm64/*.sha256 >> body.md
          echo "\`\`\`" >> body.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.init.outputs.version_tag }}
          name: ${{ needs.init.outputs.version_tag }}
          body_path: body.md
          files: |
            artifacts/caddy-amd64/caddy-linux-amd64
            artifacts/caddy-amd64/caddy-linux-amd64.sha256
            artifacts/caddy-arm64/caddy-linux-arm64
            artifacts/caddy-arm64/caddy-linux-arm64.sha256
            artifacts/caddy-amd64/go_modules.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
