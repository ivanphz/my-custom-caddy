name: Update Dependencies

on:
  schedule:
    - cron: '0 10 * * 5'
  workflow_dispatch:
  push:
    paths:
      - 'plugins.txt'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Initialize & Update
        run: |
          # 1. 初始化 go.mod
          if [ ! -f go.mod ]; then
            go mod init github.com/${{ github.repository }}
          fi
          
          # 2. 清理旧的 replace
          if [ -f go.mod ]; then
            go list -m -f '{{if .Replace}}{{.Path}}{{end}}' all 2>/dev/null | while read -r pkg; do
              if [ -n "$pkg" ]; then
                echo "Removing old replace: $pkg"
                go mod edit -dropreplace="$pkg"
              fi
            done
          fi
          
          # 3. 生成 tools.go
          echo '//go:build tools' > tools.go
          echo 'package main' >> tools.go
          echo 'import (' >> tools.go
          
          declare -A seen_imports
          declare -a failed_imports
          
          # 4. 处理 plugins.txt
          if [ -f plugins.txt ]; then
            while read -r line; do
              [ -z "$line" ] && continue
              
              echo "Processing: $line"
              target_import=""
              
              if [[ "$line" == *"="* ]]; then
                ORIGINAL=$(echo "$line" | cut -d'=' -f1 | xargs)
                REPLACEMENT=$(echo "$line" | cut -d'=' -f2 | xargs)
                
                # 先 replace，再 get
                if go mod edit -replace "$ORIGINAL=$REPLACEMENT"; then
                  if go get "$ORIGINAL"; then
                    echo "✓ Successfully processed: $ORIGINAL -> $REPLACEMENT"
                    target_import="$ORIGINAL"
                  else
                    echo "✗ Failed to get: $ORIGINAL"
                    failed_imports+=("$ORIGINAL")
                    continue
                  fi
                else
                  echo "✗ Failed to replace: $ORIGINAL"
                  failed_imports+=("$ORIGINAL")
                  continue
                fi
              else
                if go get "$line@latest"; then
                  echo "✓ Successfully got: $line"
                  target_import="$line"
                else
                  echo "✗ Failed to get: $line"
                  failed_imports+=("$line")
                  continue
                fi
              fi
              
              # 写入 tools.go（去重）
              if [ -n "$target_import" ] && [ -z "${seen_imports[$target_import]}" ]; then
                echo "  _ \"$target_import\"" >> tools.go
                seen_imports[$target_import]=1
              fi
            done < <(grep -vE '^\s*#|^\s*$' plugins.txt)
          fi
          
          echo ')' >> tools.go
          
          # 5. 执行 tidy
          go mod tidy
          
          # 6. 报告失败的导入并根据情况退出
          if [ ${#failed_imports[@]} -gt 0 ]; then
            echo ""
            echo "::error::⚠️ The following imports failed:"
            for import in "${failed_imports[@]}"; do
              echo "  - $import"
            done
            echo ""
            echo "Please check plugins.txt and fix these entries."
            
            # 【重要】默认遇到错误会终止 Action，防止提交坏的依赖。
            # 如果你经过排查，认为这些插件缺失不影响编译，可以临时注释掉下面这行 exit 1
            exit 1
          fi
          
          echo "✓ Dependency update completed"

      - name: Check for Changes
        id: git-check
        run: |
          if git diff --quiet go.mod go.sum tools.go; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit & Push
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add go.mod go.sum tools.go
          git commit -m "chore: update dependencies from plugins.txt"
          git push
