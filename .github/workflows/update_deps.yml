name: Update Dependencies

on:
  schedule:
    - cron: '0 10 * * 5'
  workflow_dispatch:
  push:
    paths:
      - 'plugins.txt'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }} # <--- 【关键修改】使用 PAT 才能触发后续 Build

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Initialize & Update
        run: |
          if [ ! -f go.mod ]; then
            go mod init github.com/${{ github.repository }}
          fi
          go mod edit -dropreplace=all || true

          echo '//go:build tools' > tools.go
          echo 'package main' >> tools.go
          echo 'import (' >> tools.go

          grep -vE '^\s*#|^\s*$' plugins.txt | while read -r line; do
            echo "Processing: $line"
            target_import=""
            
            if [[ "$line" == *"="* ]]; then
              # === 优化开始 ===
              # 1. 解析原始包和替换包
              ORIGINAL=$(echo "$line" | cut -d'=' -f1 | xargs)
              REPLACEMENT=$(echo "$line" | cut -d'=' -f2 | xargs)
              
              # 2. 关键优化：先设置 replace，告诉 Go 这个包被替换了
              go mod edit -replace "$ORIGINAL=$REPLACEMENT"
              
              # 3. 然后再 get，此时 Go 会自动去拉取 REPLACEMENT 的代码，
              # 而不是尝试去拉取 ORIGINAL (这避免了 ORIGINAL 不存在或结构不对应的报错)
              go get "$ORIGINAL"
              
              target_import="$ORIGINAL"
              # === 优化结束 ===
            else
              go get "$line@latest"
              target_import="$line"
            fi

            # 将 import 写入 tools.go 防止被 tidy 清除
            if ! grep -q "\"$target_import\"" tools.go; then
               echo "  _ \"$target_import\"" >> tools.go
            fi
          done

      - name: Check for Changes
        id: git-check
        run: |
          if git diff --quiet go.mod go.sum tools.go; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit & Push
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add go.mod go.sum tools.go
          git commit -m "chore: update dependencies from plugins.txt"
          git push
